<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  
  <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
  <title>Dispatcher's App</title>

  <link rel="stylesheet" href="https://js.arcgis.com/3.36/esri/css/esri.css">
  <link rel="stylesheet" href="styles/style.css">
  
  <script src="https://js.arcgis.com/3.36/"></script>
  <script>
    var map; 
    require([
     
      "esri/geometry/geometryEngine",
      "dojo/_base/array",
      "esri/Color",
      "dojo/parser",
      "dijit/registry",

      "esri/map",
      "esri/dijit/Search",
      "esri/lang",
      "esri/graphic",
      "esri/InfoTemplate",
      "esri/layers/GraphicsLayer",
      "esri/layers/FeatureLayer",
      "esri/renderers/SimpleRenderer",

      "esri/geometry/Point",
      "esri/tasks/FeatureSet",

      "esri/tasks/ClosestFacilityTask",
      "esri/tasks/ClosestFacilityParameters",

      "esri/symbols/SimpleMarkerSymbol",
      "esri/symbols/SimpleLineSymbol",

      "esri/arcgis/Portal",
      "esri/arcgis/OAuthInfo",
      "esri/IdentityManager",
      "dojo/dom-style", 
      "dojo/dom-attr",
      "dojo/dom",
      "dojo/on" , 

      "esri/tasks/query",

      "dijit/form/ComboBox",
      "dijit/layout/BorderContainer",
      "dijit/layout/ContentPane",

      "dojo/_base/json",

      "dojo/promise/all",
      "dojox/gfx/fx",

      "dojo/domReady!"
    ], function(
      geometryEngine,  array, Color, parser, registry,
      Map,Search, esriLang, Graphic, InfoTemplate, GraphicsLayer,FeatureLayer, SimpleRenderer,
      Point, FeatureSet,
      ClosestFacilityTask, ClosestFacilityParameters,
      SimpleMarkerSymbol, SimpleLineSymbol,arcgisPortal,OAuthInfo,esriId ,domStyle, domAttr,dom, on, Query , dojoJson , 
       all , fx , 
    ) {
      
      parser.parse();

      var info = new OAuthInfo({
      appId: "y62LHg9sepTcEzb0",
      popup: false
    });
    esriId.registerOAuthInfos([info]);

    esriId.checkSignInStatus(info.portalUrl + "/sharing").then(
      function (){
        displayMap();
      }
    ).otherwise(
      function (){
        // Anonymous view
        domStyle.set("anonymousPanel", "display", "block");
        domStyle.set("personalizedPanel", "display", "none");
      }
    );

    on(dom.byId("sign-in"), "click", function (){
      console.log("click", arguments);
      // user will be redirected to OAuth Sign In page
      esriId.getCredential(info.portalUrl + "/sharing");
    });

    on(dom.byId("sign-out"), "click", function (){
      esriId.destroyCredentials();
      window.location.reload();
    });

    function displayMap () {
      var incidentsGraphicsLayer , geoAmbulance ;

      new arcgisPortal.Portal(info.portalUrl).signIn().then(
        function (portalUser){
          console.log("Signed in to the portal: ", portalUser);

          domAttr.set("userId", "innerHTML", portalUser.fullName);
          domStyle.set("anonymousPanel", "display", "none");
          domStyle.set("personalizedPanel", "display", "block");
          
        }
      ).otherwise(
        function (error){
          console.log("Error occurred while signing in: ", error);
        }
      ) 

      /*** Creating a map ***/
      map = new Map("map", {
        center: [10, 35],  // les références de la Tunisie
        zoom: 7,
        basemap: "topo",
        showInfoWindowOnClick: false
      });

      var search = new Search({
          map: map
        }, "search");
      search.startup();

      var ambulanceLayer = new FeatureLayer ("https://services8.arcgis.com/fM0eo5ptjcKgJViW/arcgis/rest/services/workforce_ceea173740504353aa50e5cc6a3b33b8/FeatureServer/1" , {
        
        id: "ambulance",
        mode: FeatureLayer.MODE_SNAPSHOT,
        outFields: ["*"],
        refreshInterval: 1  /* the layer is refreshed every 1min in order to keep track of the ambulances last location */

      });
      
      
      
      map.on("click", mapClickHandler);

      map.on("load", function(evtObj) {
        var map = evtObj.target;

       /* this creates the symbol of the incident it's ugly but we should cope with it for now */
        var incidentPointSymbol = new SimpleMarkerSymbol(
          SimpleMarkerSymbol.STYLE_CIRCLE,
          16,
          new SimpleLineSymbol(
            SimpleLineSymbol.STYLE_SOLID,
            new Color([89,95,35]), 2
          ),
          new Color([130,159,83,0.40])
        );

         /*the layer containing the location of an incident */ 
        incidentsGraphicsLayer = new GraphicsLayer();

        var incidentsRenderer = new SimpleRenderer(incidentPointSymbol);
        incidentsGraphicsLayer.setRenderer(incidentsRenderer);
        map.addLayer(incidentsGraphicsLayer);

        /*the following code querys the graphics of the feature layer so later on we can use the geomtry to calculate the distance */
        map.addLayer(ambulanceLayer);
        ambulanceLayer.on ("load", function() {
          var query = new Query();
            query.where = "1=1";
            ambulanceLayer.selectFeatures(query, FeatureLayer.SELECTION_NEW, function(result){
              console.log( "go ahead this part is fine");
              geoAmbulance = result //retourne les coordonnées des ambulances
            }) 
        });

      });

     /*this  is useless for now*/
      /*registry.byId("numLocations").on("change", function() {
        params.defaultTargetFacilityCount = this.value;
        clearGraphics();
      });*/

      function clearGraphics() {
        //clear graphics
        map.graphics.clear();
        incidentsGraphicsLayer.clear();
      }

      function mapClickHandler(evt) {
        clearGraphics();
        var inPoint = new Point(evt.mapPoint.x, evt.mapPoint.y, map.spatialReference);
        var location = new Graphic(inPoint);
        console.log("location", location);
        incidentsGraphicsLayer.add(location);
        console.log(incidentsGraphicsLayer.graphics[0]);
        if (ambulanceLayer.loaded) {
          findClosestAmbulance (inPoint ,geoAmbulance)
        } else {
          console.log ("loading"); 
        }
        map.graphics.enableMouseEvents();
        
      }

      function findClosestAmbulance (inPoint , ambulanceFeatures) {
        var minDistance = Infinity;
        var distance ; 
        var closestAmbulance = 0 ; 
        var buffer =  geometryEngine.geodesicBuffer(inPoint, 50 , "kilometers") ; 
        var closestAmbulances = [] ; 
        workerID=0;
        
        for (i =0 ; i< ambulanceFeatures.length ; i++){
          if ( geometryEngine.contains(buffer , ambulanceFeatures[i].geometry )  ) {
            closestAmbulances.push(ambulanceFeatures[i])
          }

        };

        var x =  0;

        while (x < closestAmbulances.length) {
          distance= geometryEngine.distance(inPoint , closestAmbulances[x].geometry , "kilometers" );
          if ( distance < minDistance && ambulanceFeatures[x].attributes.status == 1 ) { // status == 0 => ne travaille pas , status == 1 => travail , status == 2 => en pause: so we will consider the status == 2 as the one refering to a free(libre) ambance
            minDistance = distance;
            closestAmbulance = closestAmbulances[x]; 
          }
          x++ 
        }

        if (closestAmbulance === 0 ) {
          console.log("no ambulance is available ")
        } else {
          console.log(closestAmbulance); 
          console.log("the closest ambulance driver", closestAmbulance.attributes.name); //displayes the name of the selected worker
          console.log("the selected worker's ID ", closestAmbulance.attributes);
          workerID=closestAmbulance.attributes.name
          //ambulanceLayer.hide() ;
          //incidentsGraphicsLayer.add(closestAmbulance);
        }
      }

      

      function txtcontent (){
        return "<a target='_blank' href=https://geo-tebourbi.maps.arcgis.com/apps/workforce/projects/d226fe44b9f34a3ca59dd606edd5801c/dispatch/assignments/new>assing mission to the closest worker</a>";
      }
      map.on("click", function(evt) {
        var link=txtcontent();
        var p = new Point(evt.mapPoint.x, evt.mapPoint.y, map.spatialReference);
        console.log(p);
        
        if (workerID!=0){
          map.infoWindow.setTitle("NEW ASSIGNMENT");
          map.infoWindow.setContent ( "the closest ambulance driver's name is : "+workerID + "<br />" + link);
          map.infoWindow.show(evt.screenPoint,map.getInfoWindowAnchor(evt.screenPoint));
        }
        else{
          map.infoWindow.setTitle("");
          map.infoWindow.setContent ( "no ambulance is available" );
          map.infoWindow.show(evt.screenPoint,map.getInfoWindowAnchor(evt.screenPoint)); 
        }
      })
    };
  });
  </script>
</head>

<body>
  <header>
    <div id="anonymousPanel" style="display: none;">
      <span id="sign-in" class="action">Sign In</span> To access the map App.
    </div>
    <div id="personalizedPanel" style="display: none;">
      Welcome <span id="userId" style="font-weight: bold;"></span>
       - 
      <span id="sign-out" class="action">Sign Out</span>
    </div>
    <!--<div id="sidebar">
      <div id="personalizedPanel" style="display: none ">
        Welcome <span id="userId" style="font-weight: bold;"></span>
         - 
        <span id="sign-out" class="action">Sign Out</span>
        <button id="startMission">Start mission</button>
        <button id="ClearMission">Clear mission</button>
      </div>
    </div>-->
  </header>
  <div id="map" class="map">
    <div id="search"></div>
    <div id="HomeButton"></div>
  </div>

</body>
</html>
